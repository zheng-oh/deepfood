"use strict";const h=require("../../../common/vendor.js"),m=require("../../u-charts/u-charts.js"),i=require("../../u-charts/config-ucharts.js");function u(t={},...e){for(let o in e)for(let n in e[o])e[o].hasOwnProperty(n)&&(t[n]=e[o][n]&&typeof e[o][n]=="object"?u(Array.isArray(e[o][n])?[]:{},t[n],e[o][n]):e[o][n]);return t}function d(t,e){for(let o in t)t.hasOwnProperty(o)&&t[o]!==null&&typeof t[o]=="object"?d(t[o],e):o==="format"&&typeof t[o]=="string"&&(t.formatter=e[t[o]]?e[t[o]]:void 0);return t}function g(t){var e="-",o=t.getFullYear(),n=t.getMonth()+1,a=t.getDate();n>=1&&n<=9&&(n="0"+n),a>=0&&a<=9&&(a="0"+a);var r=o+e+n+e+a;return r}var p=null;function x(t,e){let o=!1;return function(){clearTimeout(o),o&&clearTimeout(o),o=setTimeout(()=>{o=!1,t.apply(this,arguments)},e)}}const y={name:"qiun-data-charts",mixins:[h.Bs.mixinDatacom],props:{type:{type:String,default:null},canvasId:{type:String,default:"uchartsid"},canvas2d:{type:Boolean,default:!1},background:{type:String,default:"none"},animation:{type:Boolean,default:!0},chartData:{type:Object,default(){return{categories:[],series:[]}}},opts:{type:Object,default(){return{}}},eopts:{type:Object,default(){return{}}},loadingType:{type:Number,default:2},errorShow:{type:Boolean,default:!0},errorReload:{type:Boolean,default:!0},errorMessage:{type:String,default:null},inScrollView:{type:Boolean,default:!1},reshow:{type:Boolean,default:!1},reload:{type:Boolean,default:!1},disableScroll:{type:Boolean,default:!1},optsWatch:{type:Boolean,default:!0},onzoom:{type:Boolean,default:!1},ontap:{type:Boolean,default:!0},ontouch:{type:Boolean,default:!1},onmouse:{type:Boolean,default:!0},onmovetip:{type:Boolean,default:!1},echartsH5:{type:Boolean,default:!1},echartsApp:{type:Boolean,default:!1},tooltipShow:{type:Boolean,default:!0},tooltipFormat:{type:String,default:void 0},tooltipCustom:{type:Object,default:void 0},startDate:{type:String,default:void 0},endDate:{type:String,default:void 0},textEnum:{type:Array,default(){return[]}},groupEnum:{type:Array,default(){return[]}},pageScrollTop:{type:Number,default:0},directory:{type:String,default:"/"},tapLegend:{type:Boolean,default:!0}},data(){return{cid:"uchartsid",inWx:!1,inAli:!1,inTt:!1,inBd:!1,inH5:!1,inApp:!1,inWin:!1,type2d:!0,disScroll:!1,openmouse:!1,pixel:1,cWidth:375,cHeight:250,showchart:!1,echarts:!1,echartsResize:{state:!1},uchartsOpts:{},echartsOpts:{},drawData:{},lastDrawTime:null}},created(){if(this.cid=this.canvasId,this.canvasId=="uchartsid"||this.canvasId==""){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",o=e.length,n="";for(let a=0;a<32;a++)n+=e.charAt(Math.floor(Math.random()*o));this.cid=n}const t=h.index.getSystemInfoSync();(t.platform==="windows"||t.platform==="macos")&&(this.inWin=!0),this.inWx=!0,this.canvas2d===!1||t.platform==="windows"||t.platform==="macos"?this.type2d=!1:(this.type2d=!0,this.pixel=t.pixelRatio),this.disScroll=this.disableScroll},mounted(){this.$nextTick(()=>{this.beforeInit()});const t=this.inH5?500:200,e=this;h.index.onWindowResize(x(function(o){if(e.mixinDatacomLoading==!0)return;let n=e.mixinDatacomErrorMessage;n!==null&&n!=="null"&&n!==""||(e.echarts?e.echartsResize.state=!e.echartsResize.state:e.resizeHandler())},t))},destroyed(){this.echarts===!0?(delete cfe.option[this.cid],delete cfe.instance[this.cid]):(delete i.cfu.option[this.cid],delete i.cfu.instance[this.cid]),h.index.offWindowResize(()=>{})},watch:{chartDataProps:{handler(t,e){typeof t=="object"?JSON.stringify(t)!==JSON.stringify(e)&&(this._clearChart(),t.series&&t.series.length>0?this.beforeInit():(this.mixinDatacomLoading=!0,this.showchart=!1,this.mixinDatacomErrorMessage=null)):(this.mixinDatacomLoading=!1,this._clearChart(),this.showchart=!1,this.mixinDatacomErrorMessage="参数错误：chartData数据类型错误")},immediate:!1,deep:!0},localdata:{handler(t,e){JSON.stringify(t)!==JSON.stringify(e)&&(t.length>0?this.beforeInit():(this.mixinDatacomLoading=!0,this._clearChart(),this.showchart=!1,this.mixinDatacomErrorMessage=null))},immediate:!1,deep:!0},optsProps:{handler(t,e){typeof t=="object"?JSON.stringify(t)!==JSON.stringify(e)&&this.echarts===!1&&this.optsWatch==!0&&this.checkData(this.drawData):(this.mixinDatacomLoading=!1,this._clearChart(),this.showchart=!1,this.mixinDatacomErrorMessage="参数错误：opts数据类型错误")},immediate:!1,deep:!0},eoptsProps:{handler(t,e){typeof t=="object"?JSON.stringify(t)!==JSON.stringify(e)&&this.echarts===!0&&this.checkData(this.drawData):(this.mixinDatacomLoading=!1,this.showchart=!1,this.mixinDatacomErrorMessage="参数错误：eopts数据类型错误")},immediate:!1,deep:!0},reshow(t,e){t===!0&&this.mixinDatacomLoading===!1&&setTimeout(()=>{this.mixinDatacomErrorMessage=null,this.echartsResize.state=!this.echartsResize.state,this.checkData(this.drawData)},200)},reload(t,e){t===!0&&(this.showchart=!1,this.mixinDatacomErrorMessage=null,this.reloading())},mixinDatacomErrorMessage(t,e){t&&(this.emitMsg({name:"error",params:{type:"error",errorShow:this.errorShow,msg:t,id:this.cid}}),this.errorShow&&console.log("[秋云图表组件]"+t))},errorMessage(t,e){t&&this.errorShow&&t!==null&&t!=="null"&&t!==""?(this.showchart=!1,this.mixinDatacomLoading=!1,this.mixinDatacomErrorMessage=t):(this.showchart=!1,this.mixinDatacomErrorMessage=null,this.reloading())}},computed:{optsProps(){return JSON.parse(JSON.stringify(this.opts))},eoptsProps(){return JSON.parse(JSON.stringify(this.eopts))},chartDataProps(){return JSON.parse(JSON.stringify(this.chartData))}},methods:{beforeInit(){this.mixinDatacomErrorMessage=null,typeof this.chartData=="object"&&this.chartData!=null&&this.chartData.series!==void 0&&this.chartData.series.length>0?(this.drawData=u({},this.chartData),this.mixinDatacomLoading=!1,this.showchart=!0,this.checkData(this.chartData)):this.localdata.length>0?(this.mixinDatacomLoading=!1,this.showchart=!0,this.localdataInit(this.localdata)):this.collection!==""?(this.mixinDatacomLoading=!1,this.getCloudData()):this.mixinDatacomLoading=!0},localdataInit(t){if(this.groupEnum.length>0)for(let s=0;s<t.length;s++)for(let c=0;c<this.groupEnum.length;c++)t[s].group===this.groupEnum[c].value&&(t[s].group=this.groupEnum[c].text);if(this.textEnum.length>0)for(let s=0;s<t.length;s++)for(let c=0;c<this.textEnum.length;c++)t[s].text===this.textEnum[c].value&&(t[s].text=this.textEnum[c].text);let e=!1,o={categories:[],series:[]},n=[],a=[];if(this.echarts===!0?e=cfe.categories.includes(this.type):e=i.cfu.categories.includes(this.type),e===!0){if(this.chartData&&this.chartData.categories&&this.chartData.categories.length>0)n=this.chartData.categories;else if(this.startDate&&this.endDate){let s=new Date(this.startDate),c=new Date(this.endDate);for(;s<=c;)n.push(g(s)),s=s.setDate(s.getDate()+1),s=new Date(s)}else{let s={};t.map(function(c,l){c.text!=null&&!s[c.text]&&(n.push(c.text),s[c.text]=!0)})}o.categories=n}let r={};if(t.map(function(s,c){s.group!=null&&!r[s.group]&&(a.push({name:s.group,data:[]}),r[s.group]=!0)}),a.length==0)if(a=[{name:"默认分组",data:[]}],e===!0)for(let s=0;s<n.length;s++){let c=0;for(let l=0;l<t.length;l++)t[l].text==n[s]&&(c=t[l].value);a[0].data.push(c)}else for(let s=0;s<t.length;s++)a[0].data.push({name:t[s].text,value:t[s].value});else for(let s=0;s<a.length;s++)if(n.length>0)for(let c=0;c<n.length;c++){let l=0;for(let f=0;f<t.length;f++)a[s].name==t[f].group&&t[f].text==n[c]&&(l=t[f].value);a[s].data.push(l)}else for(let c=0;c<t.length;c++)a[s].name==t[c].group&&a[s].data.push(t[c].value);o.series=a,this.drawData=u({},o),this.checkData(o)},reloading(){this.errorReload!==!1&&(this.showchart=!1,this.mixinDatacomErrorMessage=null,this.collection!==""?(this.mixinDatacomLoading=!1,this.onMixinDatacomPropsChange(!0)):this.beforeInit())},checkData(t){let e=this.cid;this.echarts===!0?(cfe.option[e]=u({},this.eopts),cfe.option[e].id=e,cfe.option[e].type=this.type):this.type&&i.cfu.type.includes(this.type)?(i.cfu.option[e]=u({},i.cfu[this.type],this.opts),i.cfu.option[e].canvasId=e):(this.mixinDatacomLoading=!1,this.showchart=!1,this.mixinDatacomErrorMessage="参数错误：props参数中type类型不正确");let o=u({},t);o.series!==void 0&&o.series.length>0&&(this.mixinDatacomErrorMessage=null,this.echarts===!0?(cfe.option[e].chartData=o,this.$nextTick(()=>{this.init()})):(i.cfu.option[e].categories=o.categories,i.cfu.option[e].series=o.series,this.$nextTick(()=>{this.init()})))},resizeHandler(){let t=Date.now(),e=this.lastDrawTime?this.lastDrawTime:t-3e3;t-e<1e3||h.index.createSelectorQuery().in(this).select("#ChartBoxId"+this.cid).boundingClientRect(n=>{this.showchart=!0,n.width>0&&n.height>0&&(n.width!==this.cWidth||n.height!==this.cHeight)&&this.checkData(this.drawData)}).exec()},getCloudData(){this.mixinDatacomLoading!=!0&&(this.mixinDatacomLoading=!0,this.mixinDatacomGet().then(t=>{this.mixinDatacomResData=t.result.data,this.localdataInit(this.mixinDatacomResData)}).catch(t=>{this.mixinDatacomLoading=!1,this.showchart=!1,this.mixinDatacomErrorMessage="请求错误："+t}))},onMixinDatacomPropsChange(t,e){t==!0&&this.collection!==""&&(this.showchart=!1,this.mixinDatacomErrorMessage=null,this._clearChart(),this.getCloudData())},_clearChart(){let t=this.cid;if(this.echarts!==!0&&i.cfu.option[t]&&i.cfu.option[t].context){const e=i.cfu.option[t].context;typeof e=="object"&&!i.cfu.option[t].update&&(e.clearRect(0,0,this.cWidth*this.pixel,this.cHeight*this.pixel),e.draw())}},init(){let t=this.cid;h.index.createSelectorQuery().in(this).select("#ChartBoxId"+t).boundingClientRect(e=>{e.width>0&&e.height>0?(this.mixinDatacomLoading=!1,this.showchart=!0,this.lastDrawTime=Date.now(),this.cWidth=e.width,this.cHeight=e.height,this.echarts!==!0&&(i.cfu.option[t].background=this.background=="none"?"#FFFFFF":this.background,i.cfu.option[t].canvas2d=this.type2d,i.cfu.option[t].pixelRatio=this.pixel,i.cfu.option[t].animation=this.animation,i.cfu.option[t].width=e.width*this.pixel,i.cfu.option[t].height=e.height*this.pixel,i.cfu.option[t].onzoom=this.onzoom,i.cfu.option[t].ontap=this.ontap,i.cfu.option[t].ontouch=this.ontouch,i.cfu.option[t].onmouse=this.openmouse,i.cfu.option[t].onmovetip=this.onmovetip,i.cfu.option[t].tooltipShow=this.tooltipShow,i.cfu.option[t].tooltipFormat=this.tooltipFormat,i.cfu.option[t].tooltipCustom=this.tooltipCustom,i.cfu.option[t].inScrollView=this.inScrollView,i.cfu.option[t].lastDrawTime=this.lastDrawTime,i.cfu.option[t].tapLegend=this.tapLegend),this.inH5||this.inApp?this.echarts==!0?(cfe.option[t].ontap=this.ontap,cfe.option[t].onmouse=this.openmouse,cfe.option[t].tooltipShow=this.tooltipShow,cfe.option[t].tooltipFormat=this.tooltipFormat,cfe.option[t].tooltipCustom=this.tooltipCustom,cfe.option[t].lastDrawTime=this.lastDrawTime,this.echartsOpts=u({},cfe.option[t])):(i.cfu.option[t].rotateLock=i.cfu.option[t].rotate,this.uchartsOpts=u({},i.cfu.option[t])):(i.cfu.option[t]=d(i.cfu.option[t],i.cfu.formatter),this.mixinDatacomErrorMessage=null,this.mixinDatacomLoading=!1,this.showchart=!0,this.$nextTick(()=>{this.type2d===!0?h.index.createSelectorQuery().in(this).select("#"+t).fields({node:!0,size:!0}).exec(n=>{if(n[0]){const a=n[0].node,r=a.getContext("2d");i.cfu.option[t].context=r,i.cfu.option[t].rotateLock=i.cfu.option[t].rotate,i.cfu.instance[t]&&i.cfu.option[t]&&i.cfu.option[t].update===!0?this._updataUChart(t):(a.width=e.width*this.pixel,a.height=e.height*this.pixel,a._width=e.width*this.pixel,a._height=e.height*this.pixel,setTimeout(()=>{i.cfu.option[t].context.restore(),i.cfu.option[t].context.save(),this._newChart(t)},100))}else this.showchart=!1,this.mixinDatacomErrorMessage="参数错误：开启2d模式后，未获取到dom节点，canvas-id:"+t}):(this.inAli&&(i.cfu.option[t].rotateLock=i.cfu.option[t].rotate),i.cfu.option[t].context=h.index.createCanvasContext(t,this),i.cfu.instance[t]&&i.cfu.option[t]&&i.cfu.option[t].update===!0?this._updataUChart(t):setTimeout(()=>{i.cfu.option[t].context.restore(),i.cfu.option[t].context.save(),this._newChart(t)},100))}))):(this.mixinDatacomLoading=!1,this.showchart=!1,this.reshow==!0&&(this.mixinDatacomErrorMessage="布局错误：未获取到父元素宽高尺寸！canvas-id:"+t))}).exec()},saveImage(){h.index.canvasToTempFilePath({canvasId:this.cid,success:t=>{h.index.saveImageToPhotosAlbum({filePath:t.tempFilePath,success:function(){h.index.showToast({title:"保存成功",duration:2e3})}})}},this)},getImage(){this.type2d==!1?h.index.canvasToTempFilePath({canvasId:this.cid,success:t=>{this.emitMsg({name:"getImage",params:{type:"getImage",base64:t.tempFilePath}})}},this):h.index.createSelectorQuery().in(this).select("#"+this.cid).fields({node:!0,size:!0}).exec(e=>{if(e[0]){const o=e[0].node;this.emitMsg({name:"getImage",params:{type:"getImage",base64:o.toDataURL("image/png")}})}})},_newChart(t){this.mixinDatacomLoading!=!0&&(this.showchart=!0,i.cfu.instance[t]=new m.uCharts(i.cfu.option[t]),i.cfu.instance[t].addEventListener("renderComplete",()=>{this.emitMsg({name:"complete",params:{type:"complete",complete:!0,id:t,opts:i.cfu.instance[t].opts}}),i.cfu.instance[t].delEventListener("renderComplete")}),i.cfu.instance[t].addEventListener("scrollLeft",()=>{this.emitMsg({name:"scrollLeft",params:{type:"scrollLeft",scrollLeft:!0,id:t,opts:i.cfu.instance[t].opts}})}),i.cfu.instance[t].addEventListener("scrollRight",()=>{this.emitMsg({name:"scrollRight",params:{type:"scrollRight",scrollRight:!0,id:t,opts:i.cfu.instance[t].opts}})}))},_updataUChart(t){i.cfu.instance[t].updateData(i.cfu.option[t])},_tooltipDefault(t,e,o,n){if(e){let a=t.data;return typeof t.data=="object"&&(a=t.data.value),e+" "+t.name+":"+a}else return t.properties&&t.properties.name?t.properties.name:t.name+":"+t.data},_showTooltip(t){let e=this.cid,o=i.cfu.option[e].tooltipCustom;if(o&&o!==void 0&&o!==null){let n;o.x>=0&&o.y>=0&&(n={x:o.x,y:o.y+10}),i.cfu.instance[e].showToolTip(t,{index:o.index,offset:n,textList:o.textList,formatter:(a,r,s,c)=>typeof i.cfu.option[e].tooltipFormat=="string"&&i.cfu.formatter[i.cfu.option[e].tooltipFormat]?i.cfu.formatter[i.cfu.option[e].tooltipFormat](a,r,s,c):this._tooltipDefault(a,r,s,c)})}else i.cfu.instance[e].showToolTip(t,{formatter:(n,a,r,s)=>typeof i.cfu.option[e].tooltipFormat=="string"&&i.cfu.formatter[i.cfu.option[e].tooltipFormat]?i.cfu.formatter[i.cfu.option[e].tooltipFormat](n,a,r,s):this._tooltipDefault(n,a,r,s)})},_tap(t,e){let o=this.cid,n=null,a=null;this.inScrollView===!0||this.inAli?h.index.createSelectorQuery().in(this).select("#ChartBoxId"+o).boundingClientRect(r=>{t.changedTouches=[],this.inAli?t.changedTouches.unshift({x:t.detail.clientX-r.left,y:t.detail.clientY-r.top}):t.changedTouches.unshift({x:t.detail.x-r.left,y:t.detail.y-r.top-this.pageScrollTop}),e?this.tooltipShow===!0&&this._showTooltip(t):(n=i.cfu.instance[o].getCurrentDataIndex(t),a=i.cfu.instance[o].getLegendDataIndex(t),this.tapLegend===!0&&i.cfu.instance[o].touchLegend(t),this.tooltipShow===!0&&this._showTooltip(t),this.emitMsg({name:"getIndex",params:{type:"getIndex",event:{x:t.detail.x-r.left,y:t.detail.y-r.top},currentIndex:n,legendIndex:a,id:o,opts:i.cfu.instance[o].opts}}))}).exec():e?this.tooltipShow===!0&&this._showTooltip(t):(t.changedTouches=[],t.changedTouches.unshift({x:t.detail.x-t.currentTarget.offsetLeft,y:t.detail.y-t.currentTarget.offsetTop}),n=i.cfu.instance[o].getCurrentDataIndex(t),a=i.cfu.instance[o].getLegendDataIndex(t),this.tapLegend===!0&&i.cfu.instance[o].touchLegend(t),this.tooltipShow===!0&&this._showTooltip(t),this.emitMsg({name:"getIndex",params:{type:"getIndex",event:{x:t.detail.x,y:t.detail.y-t.currentTarget.offsetTop},currentIndex:n,legendIndex:a,id:o,opts:i.cfu.instance[o].opts}}))},_touchStart(t){let e=this.cid;p=Date.now(),i.cfu.option[e].enableScroll===!0&&t.touches.length==1&&i.cfu.instance[e].scrollStart(t),this.emitMsg({name:"getTouchStart",params:{type:"touchStart",event:t.changedTouches[0],id:e,opts:i.cfu.instance[e].opts}})},_touchMove(t){let e=this.cid,o=Date.now(),n=o-p,a=i.cfu.option[e].touchMoveLimit||24;n<Math.floor(1e3/a)||(p=o,i.cfu.option[e].enableScroll===!0&&t.changedTouches.length==1&&i.cfu.instance[e].scroll(t),this.ontap===!0&&i.cfu.option[e].enableScroll===!1&&this.onmovetip===!0&&this._tap(t,!0),this.ontouch===!0&&i.cfu.option[e].enableScroll===!0&&this.onzoom===!0&&t.changedTouches.length==2&&i.cfu.instance[e].dobuleZoom(t),this.emitMsg({name:"getTouchMove",params:{type:"touchMove",event:t.changedTouches[0],id:e,opts:i.cfu.instance[e].opts}}))},_touchEnd(t){let e=this.cid;i.cfu.option[e].enableScroll===!0&&t.touches.length==0&&i.cfu.instance[e].scrollEnd(t),this.emitMsg({name:"getTouchEnd",params:{type:"touchEnd",event:t.changedTouches[0],id:e,opts:i.cfu.instance[e].opts}}),this.ontap===!0&&i.cfu.option[e].enableScroll===!1&&this.onmovetip===!0&&this._tap(t,!0)},_error(t){this.mixinDatacomErrorMessage=t.detail.errMsg},emitMsg(t){this.$emit(t.name,t.params)},getRenderType(){this.echarts===!0&&this.mixinDatacomLoading===!1&&this.beforeInit()},toJSON(){return this}}};if(!Array){const t=h.resolveComponent("qiun-loading"),e=h.resolveComponent("qiun-error");(t+e)()}function D(t,e,o,n,a,r){return h.e({a:t.mixinDatacomLoading},t.mixinDatacomLoading?{b:h.p({loadingType:o.loadingType})}:{},{c:t.mixinDatacomErrorMessage&&o.errorShow},t.mixinDatacomErrorMessage&&o.errorShow?{d:h.p({errorMessage:o.errorMessage}),e:h.o((...s)=>r.reloading&&r.reloading(...s))}:{},{f:a.type2d},a.type2d?h.e({g:o.ontouch},o.ontouch?{h:a.cid,i:a.cid,j:a.cWidth+"px",k:a.cHeight+"px",l:o.background,m:a.disScroll,n:h.o((...s)=>r._touchStart&&r._touchStart(...s)),o:h.o((...s)=>r._touchMove&&r._touchMove(...s)),p:h.o((...s)=>r._touchEnd&&r._touchEnd(...s)),q:h.o((...s)=>r._error&&r._error(...s)),r:a.showchart,s:h.o((...s)=>r._tap&&r._tap(...s))}:{},{t:!o.ontouch},o.ontouch?{}:{v:a.cid,w:a.cid,x:a.cWidth+"px",y:a.cHeight+"px",z:o.background,A:a.disScroll,B:h.o((...s)=>r._error&&r._error(...s)),C:a.showchart,D:h.o((...s)=>r._tap&&r._tap(...s))}):{},{E:!a.type2d},a.type2d?{}:h.e({F:o.ontouch},o.ontouch?h.e({G:a.showchart},a.showchart?{H:a.cid,I:a.cid,J:a.cWidth+"px",K:a.cHeight+"px",L:o.background,M:h.o((...s)=>r._touchStart&&r._touchStart(...s)),N:h.o((...s)=>r._touchMove&&r._touchMove(...s)),O:h.o((...s)=>r._touchEnd&&r._touchEnd(...s)),P:a.disScroll,Q:h.o((...s)=>r._error&&r._error(...s))}:{},{R:h.o((...s)=>r._tap&&r._tap(...s))}):{},{S:!o.ontouch},o.ontouch?{}:h.e({T:a.showchart},a.showchart?{U:a.cid,V:a.cid,W:a.cWidth+"px",X:a.cHeight+"px",Y:o.background,Z:a.disScroll,aa:h.o((...s)=>r._tap&&r._tap(...s)),ab:h.o((...s)=>r._error&&r._error(...s))}:{})),{ac:"ChartBoxId"+a.cid})}const w=h._export_sfc(y,[["render",D],["__scopeId","data-v-0c0d2774"],["__file","/Users/xingzheng/Desktop/pickercolor/components/qiunCharts/qiun-data-charts/qiun-data-charts.vue"]]);wx.createComponent(w);
